<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0014)about:internet -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Adobe RoboHelp 8" />
<title>Automated Backup Strategies</title>
<link rel="StyleSheet" href="../Bookshelf.css" type="text/css" />
<script type="text/javascript" language="JavaScript">
//<![CDATA[
function ehlp_showtip(current,e,text)
{
  if ((parseInt(navigator.appVersion) == 4) && (navigator.appName == 'Netscape'))
  {
    document.tooltip.document.write("<layer bgColor='yellow' style='border:1px solid black;font-size:12px;'>"+ text + "<\/layer>");
    document.tooltip.document.close();
    document.tooltip.left=e.pageX+5;
    document.tooltip.top=e.pageY+5;
    document.tooltip.visibility="show";
  }
}
function ehlp_hidetip()
{
  document.tooltip.visibility="hidden";
}
//]]>
</script>
<script type="text/javascript" language="JavaScript">
//<![CDATA[
function reDo() {
  if (innerWidth != origWidth || innerHeight != origHeight)
     location.reload();
}
if ((parseInt(navigator.appVersion) == 4) && (navigator.appName == "Netscape")) {
        origWidth = innerWidth;
        origHeight = innerHeight;
        onresize = reDo;
}
onerror = null; 
//]]>
</script>
<style type="text/css">
/*<![CDATA[*/
<!--
div.WebHelpPopupMenu { position:absolute;
left:0px;
top:0px;
z-index:4;
visibility:hidden; }
-->
/*]]>*/
</style>

<script type="text/javascript" language="javascript1.2" src="../whmsg.js">
</script>
<script type="text/javascript" language="javascript" src="../whver.js">
</script>
<script type="text/javascript" language="javascript1.2" src="../whproxy.js">
</script>
<script type="text/javascript" language="javascript1.2" src="../whutils.js">
</script>
<script type="text/javascript" language="javascript1.2" src="../whlang.js">
</script>
<script type="text/javascript" language="javascript1.2" src="../whtopic.js">
</script>
</head>
<body>
<script type="text/javascript" language="javascript1.2">
//<![CDATA[
<!--
if (window.gbWhTopic)
{
        var strUrl = document.location.href;
        var bc = 0;
        var n = strUrl.toLowerCase().indexOf("bc-");
        if(n != -1)
        {
                document.location.href = strUrl.substring(0, n);
                bc = strUrl.substring(n+3);
        }

        if (window.addTocInfo)
        {
        addTocInfo("SYSTEM MAINTENANCE\nAutomated Backup Strategies");
addButton("show",BTN_TEXT,"Show Table of Contents","","","","",0,0,"","","");

        }
        if (window.writeBtnStyle)
                writeBtnStyle();

        if (window.writeIntopicBar)
                writeIntopicBar(1);

        
        

        if (window.setRelStartPage)
        {
        setRelStartPage("../Bookshelf.htm");

                autoSync(0);
                sendSyncInfo();
                sendAveInfoOut();
        }
}
else
        if (window.gbIE4)
                document.location.reload();

//-->
//]]>
</script><script type="text/javascript" language="JavaScript1.2" src="../ehlpdhtm.js">
</script><script type="text/javascript" language="javascript">
//<![CDATA[
document.write("<p  style=\"text-align:right;color:#0000ff;font-family:Arial;font-size:7pt;font-weight: normal;font-style: normal;text-decoration: none;\">");
AddMasterBreadcrumbs("../Bookshelf.htm", "color:#0000ff;font-family:Arial;font-size:7pt;font-weight: normal;font-style: normal;text-decoration: none;", "&gt;", "Home", "../Welcome_to_GroundWork_Monitor/index.htm");
document.write("<a style=\"color:#0000ff;font-family:Arial;font-size:7pt;font-weight: normal;font-style: normal;text-decoration: none;\" href=\"systemmaintenance_aboutsystemmaintenance.htm\">SYSTEM MAINTENANCE<\/a> &gt; Automated Backup Strategies<\/p>");
//]]>
</script>
<p>&#160;</p>
<h1><a name="MiniTOCBookMark1" id="MiniTOCBookMark1"></a><img src="../Shared_Images/square.gif" alt="square.gif" style="border: none;" width="15" height="15" border="0" /> System Maintenance</h1>
<h3 align="right"><a href="systemmaintenance_aboutsystemmaintenance.htm" title="Topic Home" onmouseover="if ((parseInt(navigator.appVersion) == 4) &amp;&amp; (navigator.appName == 'Netscape')) ehlp_showtip(this,event,'Topic Home');" onmouseout="if ((parseInt(navigator.appVersion) == 4) &amp;&amp; (navigator.appName == 'Netscape')) ehlp_hidetip();"><img src="../Shared_Images/homeicon.gif" alt="homeicon.gif" style="border: none;" width="33" height="27" border="0" /></a> <img src="../Shared_Images/printicon.gif" onclick="window.print()" alt="Print Page" title="Print Page" style="border: none;" width="31" height="27" border="0" /> <a href="mailto:support@groundworkopensource.com?subject=Automated Backup Strategies" title="Send Comments"><img src="../Shared_Images/commentsicon.gif" alt="commentsicon.gif" style="border: none;" width="33" height="27" border="0" /></a></h3>
<h2><a name="MiniTOCBookMark2" id="MiniTOCBookMark2"></a>Automated Backup Strategies</h2>
<p align="left">Table&#160;of&#160;Contents:&#160;<a class="dropspot" href="javascript:TextPopup(this)" id="MTHotSpot6522" name="MTHotSpot6522"><span class="MTText">Show</span><span class="MTText" style="display: none;">Hide</span></a></p>
<script type="text/javascript" language="JavaScript1.2">
//<![CDATA[
TextPopupInit('MTHotSpot6522', 'MTPOPUP6522');
//]]>
</script>
<div align="left" class="droptext" id="MTPOPUP6522" style="display: none;">
<ul style="text-align:left; list-style-type: circle;">
<li><a href="#MiniTOCBookMark3">Best Practices</a></li>
<li><a href="#MiniTOCBookMark4">Database Backup and Restore</a></li>
<li><a href="#MiniTOCBookMark9">Configuration Settings Backup and Restore</a></li>
<li><a href="#MiniTOCBookMark12">Data Files Backup and Restore</a></li>
</ul>
</div>
<p>This document refers to advanced configuration for automating the backup process of the <span style="font-style: italic;"><i>GroundWork Monitor</i></span> system and covers the topics listed in the <span style="font-style: italic;"><i>Table of Contents</i></span> above.</p>
<h3><a name="MiniTOCBookMark3" id="MiniTOCBookMark3"></a>Best Practices</h3>
<p><span style="font-weight: bold;"><b>Install Packages</b></span> The initial installation of the system, and many patches, are delivered as RPMs and .bin Bitrock packages along with defined steps for applying them. The base installation of the system from "bare metal" can be repeated exactly. The original sources and a log book or run book detailing the specific configuration entries (IP address, name, DNS, etc.) are necessary for this level of recovery.</p>
<p style="font-weight: bold;">Databases<span style="font-weight: normal;">&#160;</span><span style="font-weight: normal; font-style: italic;"><i>GroundWork Monitor</i></span> <span style="font-weight: normal;">utilizes</span> <span style="font-weight: normal; font-style: italic;"><i>PostgreSQL</i></span> <span style="font-weight: normal;">as the database engine for storage of configuration, control, and monitored status and events. The several databases are named below but are not an exhaustive list as others may be added with the integration of more projects. Each of these databases is essential to the function of</span> <span style="font-weight: normal; font-style: italic;"><i>GroundWork Monitor</i></span> <span style="font-weight: normal;">so they must be included in a backup and recovery strategy.</span></p>
<ul style="list-style: url('../Shared_Images/bullet01.gif');">
<li class="p-Bullet1">
<p class="Bullet1">GWCollageDB - GroundWork Foundation database.</p>
</li>
<li class="p-Bullet1">
<p class="Bullet1">Monarch - Configuration database.</p>
</li>
<li class="p-Bullet1">
<p class="Bullet1">Dashboard - Insight and Availability Reports database.</p>
</li>
<li class="p-Bullet1">
<p class="Bullet1">JBoss Portal - User Interface, web applications and permission databases</p>
</li>
</ul>
<p style="font-weight: bold;">Files <span style="font-weight: normal;">&#160;</span><span style="font-weight: normal; font-style: italic;"><i>GroundWork Monitor</i></span> <span style="font-weight: normal;">uses certain files which may be included in the RPMs or .bin packages for installing the product, as well as others which are added in customization. While the packages can rebuild most of them, tuning and localization must be specifically captured post install. Thus, these files must also be identified and dealt with by the backup and recovery strategy. Examples of these kinds of files include:</span></p>
<ul style="list-style: url('../Shared_Images/bullet01.gif');">
<li class="p-Bullet1">
<p class="Bullet1">/var/spool/cron/*</p>
</li>
<li class="p-Bullet1">
<p class="Bullet1">/etc/sysconfig/iptables/iptables.cfg</p>
</li>
<li class="p-Bullet1">
<p class="Bullet1">/usr/local/groundwork/etc/*</p>
</li>
</ul>
<p><span style="font-weight: bold;"><b>Conclusion</b></span> The Backup and Recovery must treat initial Installation, databases, and configuration files in different ways to insure a successful operation.</p>
<h3><a name="MiniTOCBookMark4" id="MiniTOCBookMark4"></a>Database Backup and Restore</h3>
<h4><a name="MiniTOCBookMark5" id="MiniTOCBookMark5"></a>Database Backup</h4>
<p>We recommend the following methods for backup and restore. Depending on the size of the database(s) you may choose to make the backups more frequently.</p>
<ol>
<li class="p-Numbering">
<p class="Numbering">Run a cron job to perform a complete backup of the <span style="font-style: italic;"><i>PostgreSQL</i></span> databases using the syntax in the example. This produces a point in time image of all the databases in a single backup file with a timestamp.&#160;The cron job example below automatically prunes the directory of images older than 5 days.</p>
</li>
</ol>
<p class="GroupCode2">0 */12 * * * date=`/bin/date -Iminutes`; /usr/local/groundwork/postgresql/bin/pg_dumpall -h 127.0.0.1 -U postgres -c -o -f &#160;/backup/postgres/groundwork_backup_$date.sql; /usr/bin/find /backup/postgres -mtime +5 -exec /bin/rm -rf {} \;</p>
<ol start="2" type="1">
<li class="p-Numbering">
<p class="Numbering">Once a day, at a time when change is likely to be minimal, from a cron job, perform a separate backup of the critical databases listed below.&#160;Because the syntax overwrites the existing file these backups are not persistent.</p>
</li>
</ol>
<p class="GroupCode2">0 1 * * * /usr/local/groundwork/postgresql/bin/pg_dumpall -h 127.0.0.1 -U postgres -c -o -f /backup/postgres/monarch_backup_file.sql</p>
<p class="GroupCode2">10 1 * * * /usr/local/groundwork/postgresql/bin/pg_dumpall -h 127.0.0.1 -U postgres -c -o -f /backup/postgres/GWCollage_backup_file.sql</p>
<p class="GroupCode2">20 1 * * * /usr/local/groundwork/postgresql/bin/pg_dumpall -h 127.0.0.1 -U postgres -c -o -f /backup/postgre/dashboard_backup_file.sql</p>
<ol start="3">
<li class="p-Numbering">
<p class="Numbering">Finally, in the normal course of operation when using <span style="font-style: italic;"><i>Monarch</i></span>, always select to make a backup before performing a <span style="font-style: italic;"><i>Commit</i></span>.&#160;The backups created are functionally equivalent to that produced in the cron jobs above and have the advantage of spanning all changes ever made (assuming you keep the entire list of backups). The location of the target directory in the examples is an important choice. It should be a share on a resource that is:</p>
</li>
</ol>
<p style="margin-left: 40px;">Not associated with the machine or machines being backed up.</p>
<p style="margin-left: 40px;">An off site copy should be considered, produced from the dump files by writing to removable media.</p>
<p style="margin-left: 40px;">Regularly scheduled rotation of the offsite media should be set up in accordance with your company’s data retention and recovery policy guidelines</p>
<p style="font-weight: bold; color: #ff0000;">Notes:</p>
<ul style="list-style: url('../Shared_Images/bullet01.gif');">
<li class="p-Bullet1">
<p class="Bullet1">The process of making a complete PostgreSQL dump can be several minutes and during the time of backup the database may be unavailable for regular updates by the monitoring engine. &#160;Therefore it is not practical to perform such backups excepting when the monitoring system has little or no activity or when it can be guaranteed to be inactive.</p>
</li>
</ul>
<ul style="list-style: url('../Shared_Images/bullet01.gif');">
<li class="p-Bullet1">
<p class="Bullet1">You can mitigate the effects of the interaction between backup and system use. &#160;By stopping <span class="CodeInline">gwservices</span> before making the backup, and restarting them afterward, the database <span class="CodeInline">GWCollageDB</span> is not open for updates. &#160;Feeders are quiescent and all messages that come in during the backup will be held in unprocessed log files and picked up afterward. &#160;The choice to do this should be based on experience with your installation. &#160;Periodically review the log files (<span class="CodeInline">/usr/local/groundwork/foundation/container/logs</span>) for the time when backups occur to see if connections to PostgreSQL are refused.</p>
</li>
<li class="p-Bullet1">
<p class="Bullet1">An alternative is to use transaction logging on PostgreSQL - Transaction logging means the database engine writes every transaction to a log file as the transactions are completed. &#160;The value of this is that long transactions, like the backup operation, can co exist with other activities, and that recovery of the database is possible up to a moment in time, useful in case of system failure. &#160;The combination of the most recent full system backup (a "postgreSQL dump") and any log files produced since that backup can produce a clean recovery.</p>
</li>
<li class="p-Bullet1">
<p class="Bullet1">The consequence to customers is that a system failure which results in data loss on the monitoring server may compromise recovery of the running image and PostgreSQL databases. If in place recovery fails then the most recent backup image will be used. &#160;The loss of monitoring data (status and availability) and configuration changes to Monarch, users, dashboards, and the portal will be for the period between the most recent backup and the time that recovery is complete.</p>
</li>
</ul>
<h4><a name="MiniTOCBookMark6" id="MiniTOCBookMark6"></a>Database Restore</h4>
<p>Which backup image you use is dependent on the type of failure you have encountered. &#160;Assess the situation and choose the image that presents the smallest amount of work to recover. &#160;The steps in recovery follow.</p>
<h4><a name="MiniTOCBookMark7" id="MiniTOCBookMark7"></a>Loss of the entire PostgreSQL facility</h4>
<ol>
<li class="p-Numbering">
<p class="Numbering">Bring up the new server or installation by recovering to the point of a running PostgreSQL with the correct filesystems in place.</p>
</li>
<li class="p-Numbering">
<p class="Numbering">If there are any applications running (like <span class="CodeInline">gwservices</span>) stop them.</p>
</li>
<li class="p-Numbering">
<p class="Numbering">Unzip the latest available postgreSQL dump file onto an accessible file share.</p>
</li>
<li class="p-Numbering">
<p class="Numbering">Recover by making the following entry where <span class="CodeInline">xxx</span> is the file name of the dump:</p>
</li>
</ol>
<p class="GroupCode2">pg_restore -d DATABASE_NAME -F t -c xxx</p>
<ol start="5">
<li class="p-Numbering">
<p class="Numbering">Restart the PostgreSQL engine and associated GW services.</p>
</li>
</ol>
<p class="GroupCode2">/usr/local/groundwork/ctlscript.sh restart postgresql</p>
<p class="GroupCode2">/usr/local/groundwork/ctlscript.sh restart gwservices</p>
<ol start="6" type="1">
<li class="p-Numbering">
<p class="Numbering">After relaunching your browser, you should clear your browser's cache.</p>
</li>
</ol>
<h4><a name="MiniTOCBookMark8" id="MiniTOCBookMark8"></a>Loss of a component</h4>
<ol>
<li class="p-Numbering">
<p class="Numbering">Perform the steps above substituting in <span class="CodeInline">xxx</span> with the particular file associated with the recovery; for example <span class="CodeInline">gwcollagedb</span> and where <span class="CodeInline">xxx</span> is the file name of the dump.</p>
</li>
</ol>
<p class="GroupCode2">pg_restore -d gwcollagedb -F t -c xxx</p>
<ol start="2">
<li class="p-Numbering">
<p class="Numbering">Restart the PostgreSQL engine and associated GW services</p>
</li>
</ol>
<p class="GroupCode2">/usr/local/groundwork/ctlscript.sh restart postgresql</p>
<p class="GroupCode2">/usr/local/groundwork/ctlscript.sh restart gwservices</p>
<ol start="3" type="1">
<li class="p-Numbering">
<p class="Numbering">After relaunching your browser, you should clear your browser's cache.</p>
</li>
</ol>
<h3><a name="MiniTOCBookMark9" id="MiniTOCBookMark9"></a>Configuration Settings Backup and Restore</h3>
<h4><a name="MiniTOCBookMark10" id="MiniTOCBookMark10"></a>Configuration Backup</h4>
<p>The installation includes configuration files and customizations, which you may have to replace in the event of loss due to accident or upgrade. Here is a recommended procedure to support the restoration of configuration files and customizations after such an accident or upgrade.</p>
<p>Identify all the configuration files, by path and name, in a single change control file at minimum, or in an organized scheme such as CF Engine or CVS. &#160;Produce a backup of these changed files, on a secure resource, along with the database backups, for future recovery. &#160;Perform a scheduled review of the accuracy of the saved file copies, making regular updates.</p>
<p>Here is an example cron job that uses the simplistic change file approach (we recommend that you set up a more professional regime which is out of the scope of the normal project).</p>
<p class="CodeGroup">0 1 * * * date=`/bin/date -Iminutes`; tar –cT yyy | /bin/gzip -c &gt; /backup/configs/groundwork-$date.gz; /usr/bin/find /backup/configs -mtime +5 -exec /bin/rm -rf {} \;</p>
<p>Replace <span class="CodeInline">yyy</span> with the path and name of the file containing the change file list. &#160;Make sure that the backup files are on a share that is not part of the machine&#160;being backed up. Consider taking copies of site regularly.</p>
<h4><a name="MiniTOCBookMark11" id="MiniTOCBookMark11"></a>Configuration Restore</h4>
<p>Recovery may consist of replacing a few files, which were overwritten in an upgrade, or an entire installation that is rebuilt from scratch after server loss. &#160;In either case the recommendation is to <span class="CodeInline">untar</span> the latest backup into a temporary file system (<span class="CodeInline">/tmp</span>) and work through the recovered list file by file, comparing each one with its counterpart before overwriting.</p>
<h3><a name="MiniTOCBookMark12" id="MiniTOCBookMark12"></a>Data Files Backup and Restore</h3>
<h4><a name="MiniTOCBookMark13" id="MiniTOCBookMark13"></a>Data Files Backup</h4>
<p>These are RRD files with value for long-term analysis.&#160;These files are updated in operational mode frequently by the monitoring process. A successful backup means capturing the changes without getting partially written files. The decision to capture these must be driven by requirement.</p>
<p>The GroundWork Monitor controlled active or passive checks produce RRD files; In order to back them up successfully we recommend integrating the backup with the file based performance data processing &#160;(for Nagios). &#160;This requires at the least halting the generating process Nagios. Following this, perform a backup. &#160;Then restart the appropriate daemon or cron job.</p>
<h4><a name="MiniTOCBookMark14" id="MiniTOCBookMark14"></a>Data Files Restore</h4>
<p>As with making the backup, care must be exercised to avoid collision between the generating process and the restore process. Stop the daemons, perform the restore, start the daemons.</p>
<div style="width: 100%; position: relative;" id="footer">
<p class="Footer" style="font-size: 7pt; line-height: Normal; margin-top: 6pt; margin-bottom: 4pt;">GroundWork, Inc. ©2011</p>
</div>
<script type="text/javascript" language="JavaScript">
//<![CDATA[
 if ((parseInt(navigator.appVersion) == 4) && (navigator.appName == 'Netscape'))
  document.write("<div id='tooltip' class='WebHelpPopupMenu'><\/div>");
//]]>
</script><script type="text/javascript" language="javascript1.2">
//<![CDATA[
<!--
if (window.writeIntopicBar)
        writeIntopicBar(0);


highlightSearch();
//-->
//]]>
</script>
</body>
</html>
