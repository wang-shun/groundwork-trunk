select u.tablespace_name, round((u.total_mb-nvl(f.free_mb+decode(sign(u.total_mb-current_mb),1,u.total_mb-current_mb,0),0))*100/u.total_mb,0) pct_used from (select tablespace_name, round(sum(bytes)/1024/1024,0) current_mb, round(sum(decode(autoextensible, 'NO', bytes, decode(sign(bytes-maxbytes),1, bytes, 0, bytes, maxbytes)))/1024/1024,0) total_mb from dba_data_files group by tablespace_name) u, (select tablespace_name, round(sum(bytes)/1024/1024,0) free_mb from dba_free_space group by tablespace_name ) f, (select tablespace_name, contents from dba_tablespaces) t where u.tablespace_name = f.tablespace_name (+) and t.tablespace_name = u.tablespace_name and t.contents not in ('UNDO','TEMPORARY') order by pct_used desc
